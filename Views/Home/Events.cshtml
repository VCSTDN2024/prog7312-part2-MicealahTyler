@model MzansiFoSho_ST10070824.Models.EventsIndexViewModel
@{
    ViewBag.Title = "Local Events & Announcements";
}
<style>
    body {
        background-color: #d4edda;
    }
</style>

<h2 class="mt-2">MzansiFoSho — Local Events & Announcements</h2>
<p class="text-muted">@Model.InfoMessage</p>

<form method="get" class="form-inline" style="margin:10px 0;">
    <input type="text" name="search" value="@Model.Search"
           placeholder="Search events, e.g. 'Johannesburg' or 'Health'"
           class="form-control" />

    <select name="category" class="form-control">
        <option value="">All Categories</option>
        @foreach (var c in Model.Categories)
        {
            <option value="@c" selected="@(Model.Category == c)">
                @c
            </option>
        }
    </select>

    <button class="btn btn-primary" type="submit">Search</button>
</form>
<div class="row">
    <div class="col-md-8">
        <h3>Events</h3>
        <table class="table table-striped">
            <thead>
            <tr><th>Title</th><th>Category</th><th>Date</th><th>Location</th><th></th></tr>
            </thead>
            <tbody>
            @foreach (var e in Model.Events)
            {
                <tr>
                    <td>@e.Title</td>
                    <td>@e.Category</td>
                    <td>@e.Date.ToString("yyyy-MM-dd")</td>
                    <td>@e.Location</td>
                    <td><a class="btn btn-sm btn-outline-secondary" href="@Url.Action("EventDetails","Events", new { id = e.Id })">View</a></td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <div class="col-md-4">
        <h4>Recommended For You</h4>
        <ul class="list-group">
            @foreach (var r in Model.Recommendations)
            {
                <li class="list-group-item">
                    <strong>@r.Title</strong><br/>
                    <small>@r.Category • @r.Date.ToString("dd MMM")</small>
                </li>
            }
        </ul>

        <h4 class="mt-3">Recently Viewed</h4>
        <ol>
            @foreach (var rv in Model.RecentlyViewed) { <li>@rv.Title</li> }
        </ol>

        <h4 class="mt-3">Upcoming (Queue)</h4>
        <ol>
            @foreach (var up in Model.UpcomingQueue) { <li>@up.Title (@up.Date.ToString("dd MMM"))</li> }
        </ol>

        <button id="popBtn" class="btn btn-sm btn-success mt-2">Show Most Popular</button>
        <div id="popOut" class="text-success" style="margin-top:6px;"></div>
    </div>
</div>

@section scripts {
<script>
    document.getElementById('popBtn').addEventListener('click', function () {
        fetch('@Url.Action("MostPopular","Events")', { method: 'POST', headers: { "X-Requested-With":"XMLHttpRequest" } })
            .then(r => r.json())
            .then(d => {
                if (d.ok) document.getElementById('popOut').innerText = `🔥 ${d.title} (${d.date})`;
                else document.getElementById('popOut').innerText = 'No popular events available.';
            });
    });
</script>
}
